
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta charset="utf-8">
    <title>01餐廳地圖</title>
    <script src="library/piwik.min.js"></script>
    <script src="https://www.googletagmanager.com/gtag/js"></script>
    <script src="src/trackerClient.js"></script>

     <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

     <!-- Font Awesome Free -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">


    <link rel="stylesheet" href="src/style.css" crossorigin="anonymous">
 
    <script type="text/javascript" src="src/districts.js"></script>
  </head>
  <body>
    <div id="bigcontainer">
      <div id="header">
        <input id="pac-input" class="form-control" type="text" placeholder="搜尋餐廳">
        <ul class="scrollmenu" id="screen-selector"></ul>
      </div>
      <div id="map"></div>
      <script>
        var current_district = "all";
        var isMobile = true;
        var temp_zoom;
        var temp_coord;

        var watchWidth = window.matchMedia("(max-width: 576px)");
        watchWidth.addListener(checkScreenWidth) // Attach listener function on state changes

        function init(){
          detectBrowser();
          checkScreenWidth(watchWidth);
          init_district();
          console.log("Current district: " + current_district);
          if (current_district != "all") setScope("anchor", current_district);
          populateHeader(district_data);
          initMap();
        }


        function checkScreenWidth(x) {
            if (x.matches) { // If media query matches
                isMobile = true;
            } else {
                isMobile = false;
            }
            console.log("is mobile:  "+ isMobile);
        }


        function findWithAttr(array, attr, value) {
              for(var i = 0; i < array.length; i += 1) {
                  if(array[i][attr] === value) {
                      return i;
                  }
              }
              return -1;
          }

        function detectBrowser() {
          var useragent = navigator.userAgent;
          var mapdiv = document.getElementById("map");
          console.log("Screen width: " + screen.width);

          if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1 ) {
            mapdiv.style.width = '100%';
            mapdiv.style.height = '100%';
          } 
        }

        function populateHeader(jsonObj) {
          navbar = document.querySelector(".scrollmenu");
          var districts = jsonObj;
           for (var i = 0; i < districts.length; i++) { 
              var listItem = document.createElement('li');
              var ahref = document.createElement("a");
              ahref.textContent = districts[i].display_name;
              ahref.setAttribute("href", '#'+districts[i]["anchor"]);
              ahref.setAttribute("id", districts[i]["btn-id"]);
              navbar.appendChild(listItem);
              listItem.appendChild(ahref);
              if (current_district == districts[i]["anchor"]) listItem.setAttribute("class", "active");
            }
        }

        // Set Entry District 
        function init_district() {
          var linkText = window.location.href;
          console.log("url: "+linkText);
          if (linkText.match(/#/)) current_district = linkText.match(/#(.*)/)[1];
        }
      
        // Create Google Map
        function initMap() {
          var hk = {lat: 22.3750568, lng: 114.1050191}; //{lat: 22.3750568, lng: 114.1050191}; 
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12, 
            minZoom: 11.5,
            center: hk,
            mapTypeControl: false,
            streetViewControl: false,
            gestureHandling: "greedy"
          });

          // Onload
          if (current_district != "all") {
            map.panTo(temp_coord);
            map.setZoom(temp_zoom);
          } else
          {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
                map.setCenter(pos);
              }, function() {
                console.log("GPS Located");
              });
            } else {
              // Browser doesn't support Geolocation
              console.log("Browser doesn't support Geolocation");
            }
          }

          // Load GeoJSON.
          map.data.loadGeoJson('src/restaurant.json', null, function(features) {
              // group items / cluster
          var infoWin = new google.maps.InfoWindow();
          var markers = features.map(function(feature) {
              var g = feature.getGeometry();

              var marker = new google.maps.Marker({
                  'position': g.get(0),
                  'data' : feature,
                  'icon' : 'markerclusterer/m1.png'
              });
            google.maps.event.addListener(marker, 'click', function(evt) {
              var info_name = marker.data.f.name;
              var info_address = marker.data.f.address;
              var info_phone = marker.data.f.phone;
              var info_opening_hour = marker.data.f.opening_hour;
              var info_play_schedule = marker.data.f.play_schedule;
              var info_reservation = marker.data.f.reservation;
              var info_min_charge = marker.data.f.min_charge;
              var info_special_event = marker.data.f.special_event;

              var share_info = info_name + ' | ' + info_address;
              console.log(share_info);
              var content = "<div id='iw-container'>"+
              "<h6>"+info_name+"</h6>"+
                "<div class='info-content'>"+
                  "<dl class='row'>"+
                    "<dt class='col-1'><i class='fas fa-map-marker-alt'></i></dt><dd class='col-11'>"+info_address+"</dd>"+
                    "<dt class='col-1'><i class='fas fa-phone'></i></dt><dd class='col-11'>"+info_phone+"</dd>"+
                    "<dt class='col-1'><i class='far fa-clock'></i></dt><dd class='col-11'>"
              if (info_opening_hour) content += info_opening_hour;
              else content += "未有提供營業時間";
                 content += "</dd>"+
                    "<dt class='col-1'><i class='fas fa-calendar-alt'></i></dt><dd class='col-11'>播放場次："
              if (info_play_schedule) content += info_play_schedule;
              else content += "未有提供";
                 content += "</dd>"+
                    "<dt class='col-1'><i class='fas fa-phone-volume'></i></dt><dd class='col-11'>訂位："
              if (info_reservation) content += info_reservation;
              else content += "不用";
                 content += "</dd>"+
                    "<dt class='col-1'><i class='fas fa-dollar-sign'></i></dt><dd class='col-11'>最低消費："
              if (info_min_charge) content += info_min_charge;
              else content += "沒有";
                content += "</dd></dl>"
              if (info_special_event) content += info_special_event;
                content += "</div><div id='share-button'>";
              if (isMobile)  content += "<a class='whatsapp' href='whatsapp://send?text="+share_info+"' target='_blank'>"+"<i class='fab fa-whatsapp'></i></a>";

                content +=
                  "<a class='twitter'  href='https://twitter.com/intent/tweet/?text="+share_info+"' target='_blank'>"+"<i class='fab fa-twitter'></i></a>"+
                  "<a class='telegram'  href='https://telegram.me/share/url?url=https://bit.ly/hk01wc18map&text="+share_info+"' target='_blank'>"+"<i class='fab fa-telegram'></i></a>"+
                  "<a class='copy' id='copyToClipboard' name = '"+ share_info +"' href='#' onclick=copyToClipboard()><i class='far fa-copy'></i></a>"+
                "</div>"+
              "</div>"
              infoWin.setContent(content);
              infoWin.open(map, marker);
            })
              return marker;
          });

          // create a new marker cluster
          var markerCluster = new MarkerClusterer(map, markers, {
                  imagePath: 'markerclusterer/m',
                  gridSize: 50,
                  //maxZoom: 16
                  zoomOnClick: true
              });
          });

          map.data.setStyle(function (feature) {
              return { icon: feature.getProperty('icon'), visible: false };
          });

          // Set Bound
          var bounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(22.152842, 113.831202),
            new google.maps.LatLng(22.644851, 114.455809)
            );

          var lastValidCenter = map.getCenter();

          map.addListener('center_changed', function() {
              if (!bounds.contains(map.getCenter())) {
                  map.panToBounds(bounds);
              }
          });

        // This example adds a search box to a map, using the Google Place Autocomplete
        // feature. People can enter geographical searches. The search box will return a
        // pick list containing a mix of places and predicted search terms.

        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

          // Create the search box and link it to the UI element.
          var input = document.getElementById('pac-input');
          var searchBox = new google.maps.places.SearchBox(input, {bounds: bounds});

          var markers = [];

          // Listen for the event fired when the user selects a prediction and retrieve
          // more details for that place.
          searchBox.addListener('places_changed', function() {
            var places = searchBox.getPlaces();
            if (places.length == 0) {
              return;
            }

            // Clear out the old markers.
            markers.forEach(function(marker) {
              marker.setMap(null);
              console.log("Clear out the old markers");
            });
            markers = [];

            var bounds = new google.maps.LatLngBounds();
            // For each place, get the icon, name and location.
            places.forEach(function(place) {
              if (!place.geometry) {
                console.log("Returned place contains no geometry");
                return;
              }
              var icon = {
                url: place.icon,
                size: new google.maps.Size(71, 71),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(25, 25)
              };

              // Create a marker for each place.
              markers.push(new google.maps.Marker({
                map: map,
                icon: icon,
                title: place.name,
                position: place.geometry.location
              }));

              if (place.geometry.viewport) {
                // Only geocodes have viewport.
                bounds.union(place.geometry.viewport);
              } else {
                bounds.extend(place.geometry.location);
              }
            });
            map.fitBounds(bounds);
          });

        
          // Create the search box and link it to the UI element.
          var poi_choice = document.getElementById('screen-selector');
          poi_choice.addEventListener("click", function (event) {
              if (event.target !== event.currentTarget) {
                  setScope("btn-id", event.target.id);

                  // Button style
                  var pre_active = document.querySelector(".active");
                  if (pre_active) pre_active.classList.toggle("active");
                  event.target.parentNode.classList.toggle("active");
                  map.panTo(temp_coord);
                  map.setZoom(temp_zoom);
              }
              event.stopPropagation();
          }, false);
        }

        function setScope(key, district) {
          var i = findWithAttr(district_data, key, district);
          current_district = district_data[i]['anchor'];
          temp_coord = {
              lat: (isMobile) ? district_data[i]['mlat'] : district_data[i]['lat'],
              lng: (isMobile) ? district_data[i]['mlng'] : district_data[i]['lng']
              }            
          temp_zoom = (isMobile) ? district_data[i]['mzoom'] : district_data[i]['zoom'];
          temp_zoom = (temp_zoom != "") ? temp_zoom : 17;
          console.log(current_district + " | " + temp_coord.lat + "," + temp_coord.lng + " | " + temp_zoom);
        }

        function copyToClipboard() {
          const el = document.createElement('textarea');
          el.value = document.getElementById("copyToClipboard").getAttribute("name");
          el.setAttribute('readonly', '');
          el.style.position = 'absolute';
          el.style.left = '-9999px';
          document.body.appendChild(el);
          el.select();
          document.execCommand("copy");
          alert("你已複製: " + el.value);
          document.body.removeChild(el);
      }

      </script>
      <script src="src/fireEvent.js"></script>
      <script src="src/markerclusterer.js"></script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDY8m0DgOQR3CsKGxULgswQMNSN9RRyKpo&callback=init&language=zh-TW&region=HK&libraries=places"></script>
    </div>
  </body>
</html>